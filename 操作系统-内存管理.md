---
title: 操作系统-内存管理
date: 2021-04-06 13:52:14
categories: OS
tags: [计算机基础,backend]
---

## 一.内存分配与回收

早期计算机编程并不需要过多的存储管理

随着计算机和程序越来越复杂，存储管理成为必要

目的:

确保计算机有足够的内存处理数据

确保程序可以从可用内存中获取一部分内存使用

确保程序可以归还使用后的内存以供其他程序使用

### 1.1内存分配的过程

#### 单一连续分配

单一连续分配是最简单的内存分配方式

只能在单用户、单进程的操作系统中使用

![image-20210406135541520](https://gitee.com/cao_ziqiang/img/raw/master/20210406135541.png)

#### 固定分区

固定分区分配是支持多道程序的最简单存储分配方式

内存空间被划分为若干固定大小的区域

每个分区只提供给一个程序使用，互不干扰

![image-20210406135625799](https://gitee.com/cao_ziqiang/img/raw/master/20210406135625.png)

#### 动态分区

根据进程实际需要，动态分配内存空间

涉及的数据结构:

- 动态分区空闲表

![image-20210406135953966](https://gitee.com/cao_ziqiang/img/raw/master/20210406135954.png)

- 动态分区空闲链

![image-20210406140035208](https://gitee.com/cao_ziqiang/img/raw/master/20210406140035.png)

动态分区分配算法:

- 首次适应算法(FF算法)

分配内存时从开始顺序查找适合内存区

若没有合适的空闲区，则该次分配失败

每次从头部开始，使得头部地址空间不断被划分

- 最佳适应算法(BF算法)

最佳适应算法要求空闲区链表按照容量大小排序

遍历空闲区链表找到最佳合适空闲区

- 快速适应算法(QF算法)

快速适应算法要求有多个空闲区链表

每个空闲区链表存储─种容量的空闲区

### 1.2内存回收的过程

![image-20210406140523070](https://gitee.com/cao_ziqiang/img/raw/master/20210406140523.png)

<hr/>

![image-20210406140622562](https://gitee.com/cao_ziqiang/img/raw/master/20210406140622.png)

<hr/>

![image-20210406140640340](https://gitee.com/cao_ziqiang/img/raw/master/20210406140640.png)

<hr/>

![image-20210406140657928](https://gitee.com/cao_ziqiang/img/raw/master/20210406140657.png)

<hr/>

![image-20210406140712280](https://gitee.com/cao_ziqiang/img/raw/master/20210406140712.png)

<hr/>

## 二.段页式存储管理

### 2.1页式存储管理

将进程逻辑空间等分成若干大小的页面

相应的把物理内存空间分成与页面大小的物理块

以页面为单位把进程空间装进物理内存中分散的物理块

注意点:

​	![image-20210406141047763](https://gitee.com/cao_ziqiang/img/raw/master/20210406141047.png)

<hr/>

页表:

![image-20210406141152731](https://gitee.com/cao_ziqiang/img/raw/master/20210406141152.png)

现代计算机系统中，可以支持非常大的逻辑地址空间(2 ^ 32~2 ^ 64)，这样，页表就变得非常大，要占用非常大的内存空间，如，具有32位逻辑地址空间的分页系统，规定页面大小为4KB，则在每个进程页表中的页表项可达1M(2^20)个，如果每个页表项占用1Byte，故每个进程仅仅页表就要占用1MB的内存空间。

<hr/>

### 2.2段式存储管理

将进程逻辑空间划分成若干段(非等分)

段的长度由连续逻辑的长度决定

主函数MAIN、子程序段X、子函数Y等

![image-20210406141625036](https://gitee.com/cao_ziqiang/img/raw/master/20210406141625.png)

页是物理单位，段是逻辑单位

分页是为了合理利用空间，分段是满足用户要求

页大小由硬件固定，段长度可动态变化

页表信息是一维的，段表信息是二维的

<hr/>

### 2.3段页式存储管理

分页可以有效提高内存利用率（虽然说存在页内碎片)

分段可以更好满足用户需求

先将逻辑空间按段式管理分成若干段

再把段内空间按页式管理等分成若干页

![image-20210406141927301](https://gitee.com/cao_ziqiang/img/raw/master/20210406141927.png)

## 三.虚拟内存

### 3.1虚拟内存概述

产生的原因:

有些进程实际需要的内存很大，超过物理内存的容量

多道程序设计，使得每个进程可用物理内存更加稀缺

不可能无限增加物理内存，物理内存总有不够的时候

作用:

虚拟内存是操作系统内存管理的关键技术

使得多道程序运行和大程序运行成为现实

把程序使用内存划分，将部分暂时不使用的内存放置在辅存

![image-20210406142539454](https://gitee.com/cao_ziqiang/img/raw/master/20210406142539.png)

### 3.2程序的局部性原理

局部性原理是指CPU访问存储器时，无论是存取指令还是存取数据，所访问的存储单元都趋于聚集在一个较小的连续区域中。

程序运行时，无需全部装入内存，装载部分即可

如果访问页不在内存，则发出缺页中断，发起页面置换

从用户层面看，程序拥有很大的空间，即是虚拟内存

虚拟内存实际是对物理内存的补充，速度接近于内存，成本接近于辅存

### 3.3虚拟内存的置换算法

![image-20210406143909171](https://gitee.com/cao_ziqiang/img/raw/master/20210406143909.png)

<hr/>

![image-20210406143944486](https://gitee.com/cao_ziqiang/img/raw/master/20210406143944.png)

<hr/>

替换策略发生在Cache-主存层次、主存-辅存层次

Cache-主存层次的替换策略主要是为了解决速度问题

主存-辅存层次主要是为了解决容量问题

FIFO(先进先出算法):

LFU(最不经常使用算法):

LRU(最不经常使用算法):

## 四.Linux的存储管理

### 4.1Buddy内存管理算法

Buddy算法是经典的内存管理算法;

算法基于计算机处理二进制的优势具有极高的效率;

算法主要是为了解决内存外碎片的问题;

![image-20210406144627628](https://gitee.com/cao_ziqiang/img/raw/master/20210406144627.png)

算法核心:努力让内存分配与相邻内存合并能快速进行;

算法原理:

- 向上取整为2的幂大小

![image-20210406144905849](https://gitee.com/cao_ziqiang/img/raw/master/20210406144905.png)

- 伙伴系统

![image-20210406144955150](https://gitee.com/cao_ziqiang/img/raw/master/20210406144955.png)

- 将内存外碎片问题转化为内存内碎片的问题

![image-20210406145550527](https://gitee.com/cao_ziqiang/img/raw/master/20210406145550.png)



<hr/>

算法流程:

![image-20210406145046489](https://gitee.com/cao_ziqiang/img/raw/master/20210406145046.png)

![image-20210406145153969](https://gitee.com/cao_ziqiang/img/raw/master/20210406145154.png)

![image-20210406145210464](https://gitee.com/cao_ziqiang/img/raw/master/20210406145210.png)

![image-20210406145305871](https://gitee.com/cao_ziqiang/img/raw/master/20210406145305.png)

![image-20210406145409846](https://gitee.com/cao_ziqiang/img/raw/master/20210406145409.png)





### 4.2Linux交换空间

交换空间(Swap)是磁盘的一个分区

Linux物理内存满时，会把一些内存交换至Swap空间

Swap空间是初始化系统时配置的

在linux系统中可以使用`top`命令查看系统的交换空间

作用:

冷启动内存依赖

系统睡眠依赖

大进程空间依赖

<hr/>

和虚拟内存的区别:

![image-20210406150115603](https://gitee.com/cao_ziqiang/img/raw/master/20210406150115.png)



